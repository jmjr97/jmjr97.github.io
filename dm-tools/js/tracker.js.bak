const player_form = document.querySelector('form');
const player_input = document.getElementById('player_input');
const add_button = document.getElementById('add_player');
const clear_button = document.getElementById('clear_turn');
const clear_rolls = document.getElementById('clear_rolls');
const player_list = document.getElementById('player_list');
const round = document.getElementById('round');
const elap_minutes = document.getElementById('min')
const elap_seconds = document.getElementById('sec')
const min_label = document.getElementById('min_label');
const round_min = document.getElementsByClassName('round_min');

let round_num = 1;
let round_seconds = 0;
let round_minutes = 0;

round.innerText = round_num;

let all_players = get_players();
update_players();

player_form.addEventListener('submit', function(e) {
  e.preventDefault();
  add_player();
})

function add_player() {
  const name_text = player_input.value.trim();
  if(name_text) {
    const player_object = {
      name: name_text,
      roll: '',
      hp: '',
      completed: false,
      note: '',
    }
    all_players.push(player_object);
    update_players();
    save_players();
    player_input.value = '';
  }
}

function update_players() {
  player_list.innerHTML = '';

  all_players.forEach((player, player_index)=> {
    let player_item = create_player_item(player, player_index);
    player_list.append(player_item);
  })
}

function create_player_item(player, player_index) {
  const player_id = 'player-'+player_index;
  const Player = document.createElement('li');
  const player_name = player.name;
  const player_roll = player.roll;
  const player_hp = player.hp;
  const player_note = player.note;

  if (round_seconds >= 60) {
    round_minutes++;
    round_seconds -= 60;
  }

  round.innerText = round_num;
  elap_seconds.innerText = round_seconds;
  elap_minutes.innerText = round_minutes;

  Player.innerHTML = `
    <div class='top'>
      <input type='checkbox' tabIndex='-1' class='doneTurn' id='${player_id}'>
      <div class='labels'>
        <label class='title-init'>Init</label>
        <input type='text' onFocus='this.select()' inputmode='numeric' maxlength='2' class='roll' id='${player_id}' value='${player_roll}'></input>
      </div>
      <div class='labels'>
        <label class='title-hp'>Hp</label>
        <input type='text' onFocus='this.select()' inputmode='numeric' maxlength='3' tabIndex='-1' class='hp' id='${player_id}' value='${player_hp}'></input>
      </div>
      <label for'${player_id}' class='player_name'>${player_name}</label>
      <button class='delete' tabIndex='-1'>Delete</button>
    </div>
    <div class='bottom'>
      <input type='text' placeholder='Notes:' maxlength='46' tabIndex='-1' class='note' id='${player_id}' value='${player_note}'>
    </div>
  `
  const delete_player = Player.querySelector('.delete');
  delete_player.addEventListener('click', () => {
  delete_player_item(player_index);
  })  

  const checkbox = Player.querySelector('.doneTurn');
  checkbox.addEventListener('change', () => {
    all_players[player_index].completed = checkbox.checked;
    save_players();
  })

  const roll = Player.querySelector('.roll');
  roll.addEventListener('change', () => {
    all_players[player_index].roll = roll.value;
    all_players.sort(function(a, b) {
      return b.roll - a.roll;
    })
    save_players();
    update_players();
  })

  const hp = Player.querySelector('.hp');
  hp.addEventListener('change', () => {
    all_players[player_index].hp = hp.value;
    save_players();
    update_players();
  })

  const note = Player.querySelector('.note');
  note.addEventListener('change', () => {
    all_players[player_index].note = note.value;
    save_players();
    update_players();
  })

  checkbox.checked = player.completed;
  return Player;
}

clear_button.addEventListener('click', () => {
  all_players.forEach((player) => {
    player.completed = false;
  })
  round_num++;
  round_seconds += 6;
  save_players();
  update_players();
})

clear_rolls.addEventListener('click', () => {
  if(window.confirm('Clear Initiative Rolls?')) {
    all_players.forEach((player) => {
      player.roll = '';
    })
    round_num = 1;
    round_seconds = 0;
    round_minutes = 0;
    save_players();
    update_players();
  }
})

function delete_player_item(player_index) {
  all_players = all_players.filter((_, i) => i !== player_index);
  save_players();
  update_players();
}

function save_players() {
  const players_json = JSON.stringify(all_players);
  local_storage.set_item('players', players_json);
}

function get_players() {
  const players = local_storage.getItem('players') || '[]';
  return JSON.parse(players);
}
